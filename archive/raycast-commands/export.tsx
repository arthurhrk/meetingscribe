import {
  ActionPanel,
  Action,
  List,
  Form,
  showToast,
  Toast,
  getPreferenceValues,
  popToRoot,
} from "@raycast/api";
import { useState, useEffect, useRef } from "react";
import { exec } from "child_process";
import { promisify } from "util";
import { StdioClient } from "./stdio";
import { runCliJSON } from "./cli";

const execAsync = promisify(exec);

interface Preferences {
  pythonPath: string;
  projectPath: string;
  defaultModel: string;
}

interface Transcription {
  filename: string;
  path: string;
  created: string;
  duration: string;
  model: string;
  language: string;
}

const exportFormats = [
  { title: "TXT - Texto simples com timestamps", value: "txt" },
  { title: "JSON - Estruturado com metadados", value: "json" },
  { title: "SRT - Legendas para v√≠deo", value: "srt" },
  { title: "VTT - WebVTT para web", value: "vtt" },
  { title: "XML - Estruturado para processamento", value: "xml" },
  { title: "CSV - Planilha com dados segmentados", value: "csv" },
];

export default function QuickExport() {
  const [transcriptions, setTranscriptions] = useState<Transcription[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [showForm, setShowForm] = useState(false);
  const [selectedFile, setSelectedFile] = useState<string>("");
  const preferences = getPreferenceValues<Preferences>();
  const clientRef = useRef<StdioClient | null>(null);
  const runnerMode = (preferences as any).runnerMode || "stdio";

  useEffect(() => {
    if (runnerMode === "stdio") {
      clientRef.current = new StdioClient(
        preferences.pythonPath,
        preferences.projectPath,
        undefined
      );
      clientRef.current.start();
    }
    loadTranscriptions();
    return () => clientRef.current?.stop();
  }, []);

  async function loadTranscriptions() {
    try {
      setIsLoading(true);
      const resp: any = runnerMode === "stdio"
        ? await clientRef.current?.request("files.list", { type: "transcriptions", limit: 20 })
        : await runCliJSON(["-m", "src.core.runtime_cli", "files", "transcriptions", "--limit", "20"]);
      const items = resp?.data?.items || [];
      setTranscriptions(items);
    } catch (error) {
      showToast({
        style: Toast.Style.Failure,
        title: "Erro ao carregar transcri√ß√µes",
        message: "Verifique se existem transcri√ß√µes dispon√≠veis",
      });
    } finally {
      setIsLoading(false);
    }
  }

  async function quickExport(filename: string, format: string) {
    try {
      showToast({
        style: Toast.Style.Animated,
        title: "Exportando...",
        message: `${filename} ‚Üí ${format.toUpperCase()}`,
      });

      const res: any = runnerMode === "stdio"
        ? await clientRef.current?.request("export.run", { filename, format })
        : await runCliJSON(["-m", "src.core.runtime_cli", "export", filename, "--format", format]);
      if (res?.status !== "success") {
        throw new Error(res?.error?.message || "Falha na exporta√ß√£o");
      }

      showToast({
        style: Toast.Style.Success,
        title: "Exporta√ß√£o conclu√≠da!",
        message: `Arquivo salvo em ${format.toUpperCase()}`,
      });
    } catch (error) {
      showToast({
        style: Toast.Style.Failure,
        title: "Erro na exporta√ß√£o",
        message: String(error),
      });
    }
  }

  async function handleFormSubmit(values: { format: string }) {
    await quickExport(selectedFile, values.format);
    popToRoot();
  }

  if (showForm) {
    return (
      <Form
        actions={
          <ActionPanel>
            <Action.SubmitForm title="Exportar" onSubmit={handleFormSubmit} />
            <Action
              title="Voltar"
              onAction={() => setShowForm(false)}
              shortcut={{ modifiers: ["cmd"], key: "backspace" }}
            />
          </ActionPanel>
        }
      >
        <Form.Description text={`Exportando: ${selectedFile}`} />
        <Form.Dropdown id="format" title="Formato" defaultValue="txt">
          {exportFormats.map((format) => (
            <Form.Dropdown.Item
              key={format.value}
              value={format.value}
              title={format.title}
            />
          ))}
        </Form.Dropdown>
      </Form>
    );
  }

  return (
    <List
      isLoading={isLoading}
      searchBarPlaceholder="Buscar transcri√ß√µes para exportar..."
    >
      <List.Section title="Transcri√ß√µes Dispon√≠veis para Exporta√ß√£o">
        {transcriptions.map((transcription) => (
          <List.Item
            key={transcription.filename}
            title={transcription.filename}
            subtitle={`${transcription.duration} ‚Ä¢ ${transcription.language} ‚Ä¢ ${transcription.created}`}
            accessories={[{ text: transcription.model }]}
            actions={
              <ActionPanel>
                <ActionPanel.Section title="Exporta√ß√£o R√°pida">
                  <Action
                    title="Txt"
                    onAction={() => quickExport(transcription.filename, "txt")}
                  />
                  <Action
                    title="JSON"
                    onAction={() => quickExport(transcription.filename, "json")}
                  />
                  <Action
                    title="Srt"
                    onAction={() => quickExport(transcription.filename, "srt")}
                  />
                </ActionPanel.Section>
                <ActionPanel.Section title="Mais Op√ß√µes">
                  <Action
                    title="Escolher Formato‚Ä¶"
                    onAction={() => {
                      setSelectedFile(transcription.filename);
                      setShowForm(true);
                    }}
                  />
                </ActionPanel.Section>
                <ActionPanel.Section title="Atualizar">
                  <Action
                    title="Atualizar Lista"
                    onAction={loadTranscriptions}
                    shortcut={{ modifiers: ["cmd"], key: "r" }}
                  />
                </ActionPanel.Section>
              </ActionPanel>
            }
          />
        ))}
      </List.Section>

      {transcriptions.length > 0 && (
        <List.Section title="Exporta√ß√£o da √öltima Transcri√ß√£o">
          <List.Item
            title="üöÄ Export √öltimo Arquivo"
            subtitle={`${transcriptions[0].filename} (mais recente)`}
            accessories={[{ text: "√öltima transcri√ß√£o" }]}
            actions={
              <ActionPanel>
                <Action
                  title="Txt (r√°pido)"
                  onAction={() =>
                    quickExport(transcriptions[0].filename, "txt")
                  }
                />
                <Action
                  title="JSON (r√°pido)"
                  onAction={() =>
                    quickExport(transcriptions[0].filename, "json")
                  }
                />
                <Action
                  title="Escolher Formato‚Ä¶"
                  onAction={() => {
                    setSelectedFile(transcriptions[0].filename);
                    setShowForm(true);
                  }}
                />
              </ActionPanel>
            }
          />
        </List.Section>
      )}
    </List>
  );
}
